@model Facturacion.Models.Entities.Factura

@{
    ViewData["Title"] = "Nueva Factura";
}

<div class="container">
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h4><i class="fas fa-plus"></i> Nueva Factura</h4>
                </div>
                <div class="card-body">
                    <form asp-action="Create" method="post" id="facturaForm">
                        <div asp-validation-summary="ModelOnly" class="alert alert-danger"></div>
                        
                        <!-- Información básica de la factura -->
                        <div class="row">
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label asp-for="NumeroFactura" class="form-label"></label>
                                    <input asp-for="NumeroFactura" class="form-control" readonly />
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label asp-for="Fecha" class="form-label"></label>
                                    <input asp-for="Fecha" class="form-control" type="date" />
                                    <span asp-validation-for="Fecha" class="text-danger"></span>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label asp-for="ClienteId" class="form-label">Cliente</label>
                                    <select asp-for="ClienteId" class="form-select" asp-items="ViewBag.ClienteId">
                                        <option value="">-- Seleccione un cliente --</option>
                                    </select>
                                    <span asp-validation-for="ClienteId" class="text-danger"></span>
                                </div>
                            </div>
                        </div>

                        <!-- Productos -->
                        <div class="card mb-3">
                            <div class="card-header d-flex justify-content-between align-items-center">
                                <h5><i class="fas fa-shopping-cart"></i> Productos/Servicios</h5>
                                <button type="button" class="btn btn-success btn-sm" onclick="agregarLinea()">
                                    <i class="fas fa-plus"></i> Agregar Línea
                                </button>
                            </div>
                            <div class="card-body">
                                <div class="table-responsive">
                                    <table class="table" id="tablaProductos">
                                        <thead>
                                            <tr>
                                                <th>Producto</th>
                                                <th>Cantidad</th>
                                                <th>Precio Unit.</th>
                                                <th>Subtotal</th>
                                                <th>Acciones</th>
                                            </tr>
                                        </thead>
                                        <tbody id="lineasProductos">
                                            <!-- Las líneas se agregan aquí -->
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>

                        <!-- Configuración de impuestos -->
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label asp-for="IVA" class="form-label">IVA (%)</label>
                                    <input asp-for="IVA" class="form-control" type="number" step="0.01" min="0" max="100" value="0" onchange="calcularTotales()" />
                                    <span asp-validation-for="IVA" class="text-danger"></span>
                                    <div class="form-text">Dejar en 0 si no aplica IVA</div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label asp-for="IRPF" class="form-label">IRPF (%)</label>
                                    <input asp-for="IRPF" class="form-control" value="15.0" readonly />
                                    <div class="form-text">IRPF fijo del 15% según normativa española</div>
                                </div>
                            </div>
                        </div>

                        <!-- Información adicional -->
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label asp-for="FormaPago" class="form-label"></label>
                                    <select asp-for="FormaPago" class="form-select">
                                        <option value="">-- Seleccione forma de pago --</option>
                                        <option value="Transferencia">Transferencia Bancaria</option>
                                        <option value="Efectivo">Efectivo</option>
                                        <option value="Tarjeta">Tarjeta</option>
                                        <option value="Cheque">Cheque</option>
                                        <option value="Domiciliacion">Domiciliación Bancaria</option>
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label asp-for="Observaciones" class="form-label"></label>
                                    <textarea asp-for="Observaciones" class="form-control" rows="2" placeholder="Observaciones adicionales (opcional)"></textarea>
                                </div>
                            </div>
                        </div>

                        <!-- Totales -->
                        <div class="card bg-light">
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-md-3">
                                        <strong>Subtotal: <span id="subtotalDisplay">0.00 €</span></strong>
                                    </div>
                                    <div class="col-md-3">
                                        <strong>IRPF (15%): <span id="irpfDisplay">0.00 €</span></strong>
                                    </div>
                                    <div class="col-md-3">
                                        <strong>IVA: <span id="ivaDisplay">0.00 €</span></strong>
                                    </div>
                                    <div class="col-md-3">
                                        <h5 class="text-success">Total: <span id="totalDisplay">0.00 €</span></h5>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Campos hidden para totales calculados -->
                        <input type="hidden" asp-for="Subtotal" id="hiddenSubtotal" />
                        <input type="hidden" asp-for="Total" id="hiddenTotal" />

                        <div class="d-grid gap-2 d-md-flex justify-content-md-end mt-3">
                            <a asp-action="Index" class="btn btn-secondary me-md-2">
                                <i class="fas fa-arrow-left"></i> Cancelar
                            </a>
                            <button type="submit" class="btn btn-success">
                                <i class="fas fa-save"></i> Guardar Factura
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    @{await Html.RenderPartialAsync("_ValidationScriptsPartial");}
    <script>
        let contadorLineas = 0;
        const productos = [
            @if(ViewBag.Productos != null)
            {
                @foreach(var producto in (List<Facturacion.Models.Entities.Producto>)ViewBag.Productos)
                {
                    <text>
                    {
                        id: @producto.Id,
                        nombre: '@Html.Raw(producto.Nombre.Replace("'", "\\'"))',
                        precio: @producto.PrecioUnitario
                    },
                    </text>
                }
            }
        ];

        function agregarLinea() {
            const tbody = document.getElementById('lineasProductos');
            const tr = document.createElement('tr');
            tr.className = 'linea-producto';
            
            let optionsHtml = '<option value="">-- Seleccione --</option>';
            productos.forEach(p => {
                optionsHtml += `<option value="${p.id}" data-precio="${p.precio}">${p.nombre} (${p.precio}€)</option>`;
            });
            
            tr.innerHTML = `
                <td>
                    <select name="ProductoIds" class="form-select" onchange="actualizarPrecio(this)">
                        ${optionsHtml}
                    </select>
                </td>
                <td>
                    <input name="Cantidades" type="number" class="form-control" min="1" value="1" onchange="calcularSubtotalLinea(this)" />
                </td>
                <td>
                    <input name="PreciosUnitarios" type="number" class="form-control" step="0.01" readonly />
                </td>
                <td>
                    <span class="subtotal-linea">0.00 €</span>
                </td>
                <td>
                    <button type="button" class="btn btn-danger btn-sm" onclick="eliminarLinea(this)">
                        <i class="fas fa-trash"></i>
                    </button>
                </td>
            `;
            
            tbody.appendChild(tr);
            contadorLineas++;
        }

        function actualizarPrecio(select) {
            const tr = select.closest('tr');
            const selectedOption = select.options[select.selectedIndex];
            const precio = selectedOption.getAttribute('data-precio') || 0;
            const inputPrecio = tr.querySelector('input[name="PreciosUnitarios"]');
            inputPrecio.value = precio;
            calcularSubtotalLinea(inputPrecio);
        }

        function calcularSubtotalLinea(input) {
            const tr = input.closest('tr');
            const cantidad = parseFloat(tr.querySelector('input[name="Cantidades"]').value) || 0;
            const precio = parseFloat(tr.querySelector('input[name="PreciosUnitarios"]').value) || 0;
            const subtotal = cantidad * precio;
            
            tr.querySelector('.subtotal-linea').textContent = subtotal.toFixed(2) + ' €';
            calcularTotales();
        }

        function eliminarLinea(button) {
            button.closest('tr').remove();
            calcularTotales();
        }

        function calcularTotales() {
            let subtotal = 0;
            document.querySelectorAll('.subtotal-linea').forEach(span => {
                const valor = parseFloat(span.textContent.replace(' €', '')) || 0;
                subtotal += valor;
            });

            const irpfPorcentaje = 15;
            const ivaPorcentaje = parseFloat(document.querySelector('input[name="IVA"]').value) || 0;
            
            const irpfImporte = subtotal * (irpfPorcentaje / 100);
            const ivaImporte = subtotal * (ivaPorcentaje / 100);
            const total = subtotal - irpfImporte + ivaImporte;

            document.getElementById('subtotalDisplay').textContent = subtotal.toFixed(2) + ' €';
            document.getElementById('irpfDisplay').textContent = irpfImporte.toFixed(2) + ' €';
            document.getElementById('ivaDisplay').textContent = ivaImporte.toFixed(2) + ' €';
            document.getElementById('totalDisplay').textContent = total.toFixed(2) + ' €';
            
            // Actualizar campos hidden
            document.getElementById('hiddenSubtotal').value = subtotal.toFixed(2);
            document.getElementById('hiddenTotal').value = total.toFixed(2);
        }

        // Al cargar la página
        document.addEventListener('DOMContentLoaded', function() {
            // Agregar una línea por defecto
            if (productos.length > 0) {
                agregarLinea();
            } else {
                document.getElementById('lineasProductos').innerHTML = 
                    '<tr><td colspan="5" class="text-center"><div class="alert alert-warning">No hay productos disponibles. <a href="/Productos/Create">Crear producto</a>.</div></td></tr>';
            }

            // Validar formulario antes de enviar
            document.getElementById('facturaForm').addEventListener('submit', function(e) {
                const lineas = document.querySelectorAll('.linea-producto');
                let hayLineasValidas = false;
                
                lineas.forEach(tr => {
                    const select = tr.querySelector('select[name="ProductoIds"]');
                    const cantidad = tr.querySelector('input[name="Cantidades"]');
                    
                    if (select.value && parseInt(cantidad.value) > 0) {
                        hayLineasValidas = true;
                    }
                });
                
                if (!hayLineasValidas) {
                    alert('Debe agregar al menos una línea de producto válida.');
                    e.preventDefault();
                    return false;
                }
            });
        });
    </script>
}